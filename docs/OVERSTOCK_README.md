# Overstock Computation

## Overview

The overstock computation helps identify products and brands that have more inventory than needed based on the next 6 months of forecasted demand.

## Database Columns

### ASIN Table
- `stock_value` - Total inventory/stock value (renamed from `ltm_stock_value`)
- `stock_units` - Total inventory/stock units (renamed from `ltm_stock_units`)
- `stock_overstock_unit` - Units of overstock (stock_units - 6 month forecast)
- `stock_overstock_value` - Dollar value of overstock (overstock_units × unit_COGS)

### Brand Table
- `stock_value` - Total inventory/stock value (renamed from `ltm_stock_value`)
- `stock_units` - Total inventory/stock units (renamed from `ltm_stock_units`)
- `stock_overstock_unit` - Units of overstock (stock_units - 6 month forecast)
- `stock_overstock_value` - Dollar value of overstock (overstock_units × unit_COGS)

## Calculation Methodology

### Stock Overstock Units
```
stock_overstock_unit = stock_units - (sum of forecasted units for next 6 months)
```

The 6-month forecast period includes:
- November 2025
- December 2025
- January 2026
- February 2026
- March 2026
- April 2026

If the result is negative (understocked), it's set to 0.

### Stock Overstock Value
```
unit_COGS = stock_value / stock_units
stock_overstock_value = stock_overstock_unit × unit_COGS
```

Special cases:
- If `stock_units` is 0 or negative, `unit_COGS` = 0
- If `stock_value` is negative, `unit_COGS` = 0
- If `stock_overstock_unit` is 0, `stock_overstock_value` = 0

## Setup Instructions

### 1. Run Database Migration

Apply the column renaming and new columns:

```bash
cd database
mysql -u root -p lego < rename_stock_columns_add_overstock.sql
```

This will:
- Rename `ltm_stock_value` → `stock_value` (both ASIN and brand tables)
- Rename `ltm_stock_units` → `stock_units` (both ASIN and brand tables)
- Add `stock_overstock_value` column (both tables)
- Add `stock_overstock_unit` column (both tables)

### 2. Update Stock Values

Update the stock values using the existing script:

```bash
# Update stock values for ASINs (aggregates from stock table)
python database/update_ltm_metrics.py
```

Or use the SQL script directly:

```bash
cd database
mysql -u root -p lego < update_ltm_metrics.sql
```

### 3. Compute Forecasts

Generate forecasts for the next 12 months (which includes our 6-month overstock period):

```bash
python compute_forecast.py
```

### 4. Compute Overstock Values

Run the overstock computation script (choose one method):

**Option A: SQL Script (Fastest - Recommended)**
```bash
cd database
mysql -u root -p lego < compute_overstock.sql
```

**Option B: Python Script**
```bash
# Compute overstock for both ASINs and brands
python compute_overstock.py

# Or compute only ASINs
python compute_overstock.py --asins-only

# Or compute only brands
python compute_overstock.py --brands-only
```

Both scripts use efficient SQL with JOINs (single UPDATE statement per table) and should complete in seconds.

## Usage Workflow

The recommended workflow for keeping overstock values current:

1. **Monthly**: Update stock data by importing latest stock files
2. **Monthly**: Run `update_ltm_metrics.sql` to update `stock_value` and `stock_units`
3. **Monthly**: Run `compute_forecast.py` to update forecasts
4. **Monthly**: Run `compute_overstock.py` to update overstock values

## Interpreting Results

### Overstock Indicators

- **High overstock units** - Products with significantly more inventory than 6-month demand
- **High overstock value** - Products tying up significant capital in excess inventory
- **Zero overstock** - Products that are either:
  - Properly stocked (inventory matches 6-month forecast)
  - Understocked (inventory less than 6-month forecast)

### Business Actions

Products with high overstock values may require:
- Promotional campaigns to increase sales
- Price reductions to move inventory
- Reduced reordering
- Consideration for liquidation

## Technical Notes

### Data Dependencies

The overstock computation depends on:
1. **Stock data** - From the `stock` table (imported via `import_stock.py`)
2. **Forecast data** - From `forecast_asin` and `forecast_brand` tables (generated by `compute_forecast.py`)
3. **ASIN/Brand relationships** - ASINs must have a `brand_id` to be included

### Performance

- Uses efficient SQL with JOINs - single UPDATE statement per table (ASIN and brand)
- No row-by-row processing - all calculations done in SQL
- Processes 40,000+ ASINs in seconds (not minutes)
- Both Python and SQL versions use the same efficient approach

## Files Modified

### Database Scripts
- `database/rename_stock_columns_add_overstock.sql` - Migration script
- `database/compute_overstock.sql` - **NEW** SQL script to compute overstock (fastest)
- `database/update_ltm_metrics.sql` - Updated to use new column names
- `database/update_ltm_metrics.py` - Updated to use new column names

### Python Scripts
- `compute_overstock.py` - **NEW** Python script to compute overstock values
- `compute_ltm_metrics.py` - Updated to use new column names

### Flask Application
- `flask_app.py` - Updated queries to use new column names

### Templates
- `templates/index.html` - Updated to display `stock_value`
- `templates/view_asin.html` - Updated to display `stock_value`
- `templates/top_asins.html` - Updated to display `stock_value`
- `templates/brand_asins.html` - Updated to display `stock_value`

### Documentation
- `docs/LTM_METRICS_README.md` - Updated to reference `stock_value`
- `docs/OVERSTOCK_README.md` - This file (new)

## Troubleshooting

### No overstock values after running script
- Verify that `stock_value` and `stock_units` are populated (run `update_ltm_metrics.sql`)
- Verify that forecast data exists in `forecast_asin` and `forecast_brand` tables (run `compute_forecast.py`)
- Check that ASINs have `brand_id` assigned

### Unexpectedly high overstock values
- Review the forecast accuracy - if forecasts are too low, overstock will appear high
- Check if stock data is current and accurate
- Verify the forecast methodology in `compute_forecast.py`

### Script errors
- Ensure database credentials are correct in `config.ini`
- Verify all required columns exist (run the migration script)
- Check that Python dependencies are installed (`pip install -r requirements.txt`)

