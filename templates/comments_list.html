{% extends "base.html" %}

{% block title %}Comments - LEGO Apps{% endblock %}

{% block page_title %}üí¨ Comments{% endblock %}

{% block extra_styles %}
    .filter-section {
        background: #f7fafc;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 25px;
    }
    
    .filter-row {
        display: flex;
        gap: 15px;
        align-items: end;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #4a5568;
        font-size: 0.875rem;
    }
    
    .filter-group select {
        padding: 10px 15px;
        font-size: 14px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        background: white;
    }
    
    .filter-group select:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .comments-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .comment-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #667eea;
        display: flex;
        gap: 20px;
    }
    
    .comment-image {
        flex-shrink: 0;
        width: 200px;
        height: 200px;
    }
    
    .comment-image img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 8px;
        background: #f7fafc;
        border: 1px solid #e2e8f0;
    }
    
    .comment-image .no-image {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f7fafc;
        border-radius: 8px;
        color: #a0aec0;
        border: 1px solid #e2e8f0;
    }
    
    .comment-content {
        flex: 1;
    }
    
    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 10px;
    }
    
    .comment-entity {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .entity-name-link {
        font-weight: 600;
        color: #667eea;
        text-decoration: none;
    }
    
    .entity-name-link:hover {
        text-decoration: underline;
    }
    
    .entity-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .entity-badge.brand {
        background: #e0e7ff;
        color: #5568d3;
    }
    
    .entity-badge.asin {
        background: #d1fae5;
        color: #065f46;
    }
    
    .entity-badge.brand_bucket {
        background: #fce7f3;
        color: #9f1239;
    }
    
    .entity-badge.top_asin_buckets {
        background: #fef3c7;
        color: #92400e;
    }
    
    .entity-name {
        font-weight: 600;
        color: #2d3748;
    }
    
    .comment-meta {
        display: flex;
        gap: 15px;
        font-size: 0.875rem;
        color: #718096;
    }
    
    .comment-author {
        font-weight: 600;
        color: #667eea;
    }
    
    .comment-date {
        color: #a0aec0;
    }
    
    .comment-text {
        color: #4a5568;
        line-height: 1.6;
        margin-top: 10px;
        white-space: pre-wrap;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #718096;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
        color: #4a5568;
    }
    
    .comment-text p {
        margin: 0 0 10px 0;
    }
    
    .comment-text p:last-child {
        margin-bottom: 0;
    }
    
    .comment-text code {
        background: #f7fafc;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.9em;
    }
    
    .comment-text pre {
        background: #f7fafc;
        padding: 10px;
        border-radius: 6px;
        overflow-x: auto;
    }
    
    .comment-text pre code {
        background: none;
        padding: 0;
    }
    
    .comment-text a {
        color: #667eea;
        text-decoration: none;
    }
    
    .comment-text a:hover {
        text-decoration: underline;
    }
    
    .comment-text ul, .comment-text ol {
        margin: 10px 0;
        padding-left: 20px;
    }
    
    .comment-text h1, .comment-text h2, .comment-text h3 {
        margin: 15px 0 10px 0;
        font-weight: 600;
    }
    
    .comment-actions {
        display: flex;
        gap: 8px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e2e8f0;
    }
    
    .btn-edit-comment {
        padding: 6px 12px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-edit-comment:hover {
        background: #5568d3;
    }
    
    .btn-delete-comment {
        padding: 6px 12px;
        background: #e53e3e;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-delete-comment:hover {
        background: #c53030;
    }
    
    .comment-edit-form {
        display: none;
        margin-top: 15px;
    }
    
    .comment-edit-form textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
        resize: vertical;
        min-height: 120px;
    }
    
    .comment-edit-form textarea:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .comment-edit-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
    }
    
    .btn-save-comment {
        padding: 8px 16px;
        background: #48bb78;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-save-comment:hover {
        background: #38a169;
    }
    
    .btn-cancel-edit {
        padding: 8px 16px;
        background: #e2e8f0;
        color: #4a5568;
        border: none;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-cancel-edit:hover {
        background: #cbd5e0;
    }
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const currentUser = {{ (session.username if session.username else 'Unknown')|tojson|safe }};

document.addEventListener('DOMContentLoaded', function() {
    const markdownElements = document.querySelectorAll('.markdown-content');
    markdownElements.forEach(element => {
        const text = element.textContent;
        element.innerHTML = marked.parse(text);
    });
});

function editComment(commentId) {
    // Hide the comment text and actions
    document.getElementById(`comment-text-${commentId}`).style.display = 'none';
    document.getElementById(`comment-actions-${commentId}`).style.display = 'none';
    
    // Show the edit form
    document.getElementById(`edit-form-${commentId}`).style.display = 'block';
    
    // Set focus on textarea
    document.getElementById(`edit-text-${commentId}`).focus();
}

function cancelEdit(commentId) {
    // Get the textarea element
    const textarea = document.getElementById(`edit-text-${commentId}`);
    
    // Reset textarea to original text from data attribute (JSON-encoded)
    const originalTextJson = textarea.getAttribute('data-original-text');
    if (originalTextJson !== null) {
        try {
            const originalText = JSON.parse(originalTextJson);
            textarea.value = originalText;
        } catch (e) {
            console.error('Error parsing original text:', e);
        }
    }
    
    // Show the comment text and actions
    document.getElementById(`comment-text-${commentId}`).style.display = 'block';
    document.getElementById(`comment-actions-${commentId}`).style.display = 'flex';
    
    // Hide the edit form
    document.getElementById(`edit-form-${commentId}`).style.display = 'none';
}

function saveComment(commentId) {
    const text = document.getElementById(`edit-text-${commentId}`).value.trim();
    
    if (!text) {
        alert('Comment text cannot be empty');
        return;
    }
    
    fetch(`/api/comments/${commentId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ text: text })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the displayed comment text
            const commentTextElement = document.getElementById(`comment-text-${commentId}`);
            commentTextElement.textContent = text;
            commentTextElement.innerHTML = marked.parse(text);
            
            // Hide edit form and show comment text/actions
            cancelEdit(commentId, text);
        } else {
            alert('Error: ' + (data.error || 'Failed to update comment'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating comment. Please try again.');
    });
}

function deleteComment(commentId) {
    if (!confirm('Are you sure you want to delete this comment?')) {
        return;
    }
    
    fetch(`/api/comments/${commentId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the comment card from the DOM
            const commentCard = document.getElementById(`comment-card-${commentId}`) || 
                              document.querySelector(`[id*="comment-${commentId}"]`)?.closest('.comment-card');
            if (commentCard) {
                commentCard.style.transition = 'opacity 0.3s';
                commentCard.style.opacity = '0';
                setTimeout(() => {
                    commentCard.remove();
                    // Check if no comments left
                    const commentsList = document.querySelector('.comments-list');
                    if (commentsList && commentsList.children.length === 0) {
                        location.reload(); // Reload to show empty state
                    }
                }, 300);
            } else {
                // Fallback: reload the page
                location.reload();
            }
        } else {
            alert('Error: ' + (data.error || 'Failed to delete comment'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting comment. Please try again.');
    });
}
</script>
{% endblock %}

{% block content %}
    <div class="filter-section">
        <form method="GET" action="{{ url_for('comments_list') }}">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="entity_type">Filter by Entity Type</label>
                    <select name="entity_type" id="entity_type" onchange="this.form.submit()">
                        <option value="all" {% if selected_entity_type == 'all' %}selected{% endif %}>All Types</option>
                        <option value="brand" {% if selected_entity_type == 'brand' %}selected{% endif %}>Brands</option>
                        <option value="asin" {% if selected_entity_type == 'asin' %}selected{% endif %}>ASINs</option>
                        <option value="brand_bucket" {% if selected_entity_type == 'brand_bucket' %}selected{% endif %}>Brand Buckets</option>
                        <option value="top_asin_buckets" {% if selected_entity_type == 'top_asin_buckets' %}selected{% endif %}>Top ASIN Buckets</option>
                    </select>
                </div>
            </div>
        </form>
    </div>
    
    {% if comments %}
    <div class="comments-list">
        {% for comment in comments %}
        <div class="comment-card" id="comment-card-{{ comment.id }}">
            <div class="comment-image">
                {% if comment.entity_main_image %}
                    <img src="{{ comment.entity_main_image }}" alt="{{ comment.entity_name or 'Entity image' }}">
                {% else %}
                    <div class="no-image">No image</div>
                {% endif %}
            </div>
            <div class="comment-content">
                <div class="comment-header">
                    <div class="comment-entity">
                        <span class="entity-badge {{ comment.entity_type }}">{{ comment.entity_type }}</span>
                        {% if comment.entity_type == 'brand' %}
                            <a href="{{ url_for('brand_asins', brand_id=comment.entity_id) }}" class="entity-name-link">{{ comment.entity_name or ('ID: ' + comment.entity_id|string) }}</a>
                        {% elif comment.entity_type == 'asin' %}
                            <a href="{{ url_for('view_asin', asin_code=comment.asin_code) }}" class="entity-name-link">{{ comment.entity_name or ('ID: ' + comment.entity_id|string) }}</a>
                        {% elif comment.entity_type == 'top_asin_buckets' %}
                            <a href="{{ url_for('top_asins', bucket_id=comment.entity_id) }}" class="entity-name-link">{{ comment.entity_name or ('ID: ' + comment.entity_id|string) }}</a>
                        {% else %}
                            <span class="entity-name">{{ comment.entity_name or ('ID: ' + comment.entity_id|string) }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="comment-meta">
                    <span class="comment-author">üë§ {{ comment.author }}</span>
                    <span class="comment-date">üìÖ {{ comment.created_at.strftime('%Y-%m-%d %H:%M:%S') if comment.created_at else 'N/A' }}</span>
                </div>
                <div class="comment-text markdown-content" id="comment-text-{{ comment.id }}">{{ comment.text }}</div>
                {% if session.username == comment.author %}
                <div class="comment-actions" id="comment-actions-{{ comment.id }}">
                    <button class="btn-edit-comment" onclick="editComment({{ comment.id }})">‚úèÔ∏è Edit</button>
                    <button class="btn-delete-comment" onclick="deleteComment({{ comment.id }})">üóëÔ∏è Delete</button>
                </div>
                <div class="comment-edit-form" id="edit-form-{{ comment.id }}">
                    <textarea id="edit-text-{{ comment.id }}" data-original-text="{{ comment.text|tojson }}" required>{{ comment.text }}</textarea>
                    <div class="comment-edit-actions">
                        <button class="btn-save-comment" onclick="saveComment({{ comment.id }})">üíæ Save</button>
                        <button class="btn-cancel-edit" onclick="cancelEdit({{ comment.id }})">‚ùå Cancel</button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <h3>No comments found</h3>
        <p>No comments match your filter criteria.</p>
    </div>
    {% endif %}
{% endblock %}

