{% extends "base.html" %}

{% block title %}Categories Dashboard{% endblock %}

{% block content %}
<style>
    .categories-dashboard-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 20px;
        overflow-x: auto;
    }

    .dashboard-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .dashboard-header h1 {
        color: #04122C;
        font-size: 2rem;
        margin-bottom: 10px;
    }

    .dashboard-header p {
        color: #666;
        font-size: 1rem;
    }

    .load-button-container {
        text-align: center;
        margin: 30px 0;
    }

    .btn-load {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 40px;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-load:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .dashboard-table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 20px;
        margin-top: 30px;
        overflow-x: auto;
    }

    .dashboard-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }

    .dashboard-table thead th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        text-align: center;
        font-weight: 600;
        border: 1px solid #5a67d8;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .dashboard-table thead th:first-child {
        text-align: left;
        min-width: 200px;
    }

    .dashboard-table tbody td {
        padding: 12px 15px;
        border: 1px solid #e2e8f0;
        text-align: right;
    }

    .dashboard-table tbody td:first-child {
        text-align: left;
        font-weight: 600;
        background-color: #f7fafc;
        color: #2d3748;
    }

    .dashboard-table tbody tr:hover {
        background-color: #f8f9ff;
    }

    .positive {
        color: #38a169;
        font-weight: 600;
    }

    .negative {
        color: #e53e3e;
        font-weight: 600;
    }
    
    .ebitda-green {
        color: #38a169;
        font-weight: 600;
    }
    
    .ebitda-orange {
        color: #ed8936;
        font-weight: 600;
    }
    
    .ebitda-red {
        color: #e53e3e;
        font-weight: 600;
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-popup {
        background: white;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        text-align: center;
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 6px solid #f3f3f3;
        border-top: 6px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        color: #04122C;
        font-size: 1.2rem;
        font-weight: 600;
    }
</style>

<div class="categories-dashboard-container">
    <div class="dashboard-header">
        <h1>ðŸ“Š Categories Dashboard</h1>
        <p>Comprehensive view of all categories with key performance metrics</p>
    </div>

    <div class="load-button-container">
        <button class="btn-load" onclick="loadData()">ðŸ“Š Load Categories Data</button>
    </div>

    <div class="dashboard-table-container" id="tableContainer" style="display: none;">
        <table class="dashboard-table">
            <thead id="tableHead">
                <!-- Headers will be dynamically populated -->
            </thead>
            <tbody id="tableBody">
                <!-- Data will be dynamically populated -->
            </tbody>
        </table>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-popup">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading categories data...</div>
    </div>
</div>

<script>
    // EBITDA color thresholds from config.ini
    const EBITDA_GREEN_THRESHOLD = {{ ebitda_green }};
    const EBITDA_ORANGE_THRESHOLD = {{ ebitda_orange }};
    
    function getEbitdaColorClass(value) {
        if (value >= EBITDA_GREEN_THRESHOLD) {
            return 'ebitda-green';
        } else if (value >= EBITDA_ORANGE_THRESHOLD) {
            return 'ebitda-orange';
        } else {
            return 'ebitda-red';
        }
    }
    
    function loadData() {
        console.log('Loading categories data...');
        
        // Show loading overlay
        document.getElementById('loadingOverlay').classList.add('active');
        
        fetch('/api/categories-dashboard-data')
            .then(response => {
                console.log('Response received:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Data received:', data);
                updateTable(data.categories);
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').classList.remove('active');
                
                // Show table
                document.getElementById('tableContainer').style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading data:', error);
                alert('Error loading data: ' + error.message);
                document.getElementById('loadingOverlay').classList.remove('active');
            });
    }

    function updateTable(categories) {
        // Build table header - metrics as columns
        const thead = document.getElementById('tableHead');
        thead.innerHTML = '';
        
        const headerRow = document.createElement('tr');
        
        // Column headers
        const headers = [
            'Category',
            'Revenue 2024',
            'Revenue LTM (Nov 24 - Oct 25)',
            'Stock LTM (Nov 24 - Oct 25)',
            'YoY Growth %',
            'Brand EBITDA 2024 %',
            'Brand EBITDA LTM %'
        ];
        
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        
        // Build table body - each category is a row
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        categories.forEach(cat => {
            const row = document.createElement('tr');
            
            // Category name
            const categoryCell = document.createElement('td');
            categoryCell.textContent = cat.category;
            row.appendChild(categoryCell);
        
            // Revenue 2024
            const rev2024Cell = document.createElement('td');
            rev2024Cell.textContent = formatCurrency(cat.revenue_2024);
            row.appendChild(rev2024Cell);
            
            // Revenue LTM
            const revLTMCell = document.createElement('td');
            revLTMCell.textContent = formatCurrency(cat.revenue_ltm);
            row.appendChild(revLTMCell);
            
            // Stock LTM
            const stockLTMCell = document.createElement('td');
            stockLTMCell.textContent = formatCurrency(cat.stock_ltm);
            row.appendChild(stockLTMCell);
        
            // YoY Growth %
            const yoyCell = document.createElement('td');
            yoyCell.className = cat.yoy_growth >= 0 ? 'positive' : 'negative';
            yoyCell.textContent = formatPercentage(cat.yoy_growth);
            row.appendChild(yoyCell);
        
            // Brand EBITDA 2024 %
            const ebitda2024Cell = document.createElement('td');
            ebitda2024Cell.className = getEbitdaColorClass(cat.ebitda_2024);
            ebitda2024Cell.textContent = formatPercentage(cat.ebitda_2024);
            row.appendChild(ebitda2024Cell);
        
            // Brand EBITDA LTM %
            const ebitdaLTMCell = document.createElement('td');
            ebitdaLTMCell.className = getEbitdaColorClass(cat.ebitda_ltm);
            ebitdaLTMCell.textContent = formatPercentage(cat.ebitda_ltm);
            row.appendChild(ebitdaLTMCell);
            
            tbody.appendChild(row);
        });
    }

    function formatCurrency(value) {
        if (value === null || value === undefined) return '-';
        return '$' + value.toLocaleString('en-US', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
    }

    function formatPercentage(value) {
        if (value === null || value === undefined) return '-';
        return value.toFixed(1) + '%';
    }
</script>
{% endblock %}


